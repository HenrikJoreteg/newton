<!DOCTYPE html>
<html>
<head>
  <title>Simple Verlet Particles - SDW</title>
  <link rel='stylesheet' type='text/css' href='style.css' />
</head>
<body>

<div class='wrap'>
  <canvas id="display" width="800" height="450"></canvas>
  <p class='caption'>
    Particle system demonstrating <a href='http://lonesock.net/article/verlet.html'>Time-Corrected Verlet integration</a> (TCV) with bounding constraints and gravitational forces.
  </p>
  <p class='caption'>by <a href='http://skookum.com'>Skookum Digital Works</a></p>
</div>
<a href="https://github.com/skookum/verlet"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub"></a>

<script type="text/javascript" src="http://code.jquery.com/jquery-latest.js"></script>
<script src='requestAnimationFrame.js'></script>
<script src='stepper.js'></script>
<script src='particle.js'></script>
<script src='particleSystem.js'></script>
<script src='segment.js'></script>
<script>

  // Constants
  var WIDTH = 800;
  var HEIGHT = 450;
  var COLORS = ['#118888', '#3FC1A6', '#8EFFEC', '#FFFFFF', '#F10C5C'];
  var CLEAR = 'rgba(0, 0, 0, 0.5)';
  var CIRCLE_RADIUS = 2 * Math.PI;
  var NEW_BATCHES = 30;
  var GRAVITY = 0.00001;

  // Globals
  var ctx, stepper, system, segments;
  var mouse = {x: 0, y: 0, mass: 0};

  // GO!
  start();


  // Primary functions

  function start() {
    ctx = document.getElementById('display').getContext('2d');
    system = new ParticleSystem();
    segments = createSegments();
    stepper = new Stepper(frame);
    stepper.start();
  }

  function frame(time, correction) {
    clear();
    system.each(drawParticle)
    system.each(applyForces(time, correction));
    segments.forEach(drawSegment);
    drawMouse();
    shrinkMouse();
    drawParticleCount();
  }


  // Supporting functions

  function addParticles(x, y, n) {
    var dot;
    for (var i = 0; i < n; i++) {
      dot = new Particle(Math.random() * 20 + x - 10, Math.random() * 20 + y - 10, Math.random() * 3 + 1);
      dot.boundaries(0, 0, WIDTH, HEIGHT);
      dot.color = COLORS[~~(Math.random() * COLORS.length)];
      system.add(dot);
    }
  }

  function createSegments() {
    var s = [];
    s.push(new Segment(200, 100, 300, 200, true));
    s.push(new Segment(300, 200, 400, 100, true));
    s.push(new Segment(400, 100, 450, 150, true));
    s.push(new Segment(450, 150, 300, 300, true));
    s.push(new Segment(300, 300, 150, 150, true));
    s.push(new Segment(150, 150, 200, 100, true));
    return s;
  }

  function drawParticle(dot) {
    ctx.save();
    ctx.fillStyle = dot.color;
    ctx.fillRect(dot.x - dot.mass, dot.y - dot.mass, dot.mass * 2, dot.mass * 2);
    ctx.restore();
  }

  function drawSegment(segment) {
    ctx.save();
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(segment.x1, segment.y1);
    ctx.lineTo(segment.x2, segment.y2);
    ctx.closePath();
    ctx.stroke();
    ctx.restore();
  }

  function drawParticleCount() {
    var text = system.particles.length ? 'Particles: ' + system.particles.length : '(click to add particles)';
    ctx.save();
    ctx.fillStyle = '#fff';
    ctx.font = '10pt Helvetica';
    ctx.fillText(text, 10, 20);
    ctx.restore();
  }

  function drawMouse() {
    ctx.save();
    ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
    ctx.beginPath();
    ctx.arc(mouse.x, mouse.y, mouse.mass * 5 + 1, 0, CIRCLE_RADIUS, false);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  function shrinkMouse() {
    if (mouse.mass > 0) {
      mouse.mass -= 0.1;
    }
  }

  function applyForces(time, correction) {
    return function(dot) {
      // Change acceleration
      dot.accelerate(0, GRAVITY);        // Gravity
      dot.gravitate(mouse.x, mouse.y, mouse.mass);   // Mouse pull
      // Apply acceleration -> velocity -> position
      dot.integrate(time, correction);  // Apply forces
      // Apply constraints
      dot.collide(segments);            // Handle collisions with line segments
      dot.contain(time, correction);  // Keep inside display
    };
  }

  function clear() {
    ctx.save();
    ctx.fillStyle = CLEAR;
    ctx.fillRect(0, 0, WIDTH, HEIGHT);
    ctx.restore();
  }

  // jQuery
  jQuery(document).ready(function(){
    $('#display').mousemove(function(e){
      mouse = {
        x: e.pageX - this.offsetLeft,
        y: e.pageY - this.offsetTop,
        mass: 5
      };
    });
    $('#display').mousedown(function(e) {
      mouse.mass = 0.3;
      addParticles(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, NEW_BATCHES);
      return false;
    });
  });

</script>

</body>
</html>